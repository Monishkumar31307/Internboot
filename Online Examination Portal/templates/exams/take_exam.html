{% extends 'base.html' %}

{% block title %}Taking Exam: {{ exam.title }}{% endblock %}

{% block content %}
<!-- Timer -->
<div class="exam-timer" id="timer">
    <i class="bi bi-clock-fill"></i>
    <span id="time-left">{{ remaining_time }}</span> min
</div>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">{{ exam.title }}</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <p class="mb-0"><strong>Total Questions:</strong> {{ questions.count }}</p>
            </div>
            <div class="col-md-4 text-end">
                <p class="mb-0"><strong>Total Marks:</strong> {{ exam.total_marks }}</p>
            </div>
        </div>
    </div>
</div>

<form method="post" id="exam-form">
    {% csrf_token %}
    
    {% for question in questions %}
    <div class="question-card">
        <h5 class="mb-3">
            <span class="badge bg-primary">Q{{ forloop.counter }}</span>
            {{ question.question_text }}
            <span class="badge bg-success float-end">{{ question.marks }} mark{{ question.marks|pluralize }}</span>
        </h5>
        
        <div class="options">
            <label class="option-label">
                <input type="radio" name="question_{{ question.id }}" value="A" 
                    {% if submitted_answers|get_item:question.id == 'A' %}checked{% endif %}>
                <span><strong>A.</strong> {{ question.option_a }}</span>
            </label>
            
            <label class="option-label">
                <input type="radio" name="question_{{ question.id }}" value="B"
                    {% if submitted_answers|get_item:question.id == 'B' %}checked{% endif %}>
                <span><strong>B.</strong> {{ question.option_b }}</span>
            </label>
            
            <label class="option-label">
                <input type="radio" name="question_{{ question.id }}" value="C"
                    {% if submitted_answers|get_item:question.id == 'C' %}checked{% endif %}>
                <span><strong>C.</strong> {{ question.option_c }}</span>
            </label>
            
            <label class="option-label">
                <input type="radio" name="question_{{ question.id }}" value="D"
                    {% if submitted_answers|get_item:question.id == 'D' %}checked{% endif %}>
                <span><strong>D.</strong> {{ question.option_d }}</span>
            </label>
        </div>
    </div>
    {% endfor %}
    
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <button type="submit" name="save_answers" class="btn btn-warning w-100">
                        <i class="bi bi-save"></i> Save Answers
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="submit" name="submit_exam" class="btn btn-success w-100" 
                            onclick="return confirm('Are you sure you want to submit? You cannot change answers after submission.')">
                        <i class="bi bi-check-circle"></i> Submit Exam
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Timer countdown
    let timeLeft = {{ remaining_time }};
    
    function updateTimer() {
        const minutes = Math.floor(timeLeft);
        const seconds = Math.floor((timeLeft - minutes) * 60);
        
        document.getElementById('time-left').textContent = 
            minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        
        if (timeLeft <= 5) {
            document.getElementById('timer').style.backgroundColor = '#ef476f';
        }
        
        if (timeLeft <= 0) {
            alert('Time is up! Submitting exam...');
            document.getElementById('exam-form').submit();
            return;
        }
        
        timeLeft -= 1/60;  // Decrease by 1 second
        setTimeout(updateTimer, 1000);
    }
    
    updateTimer();
    
    // Warn before leaving page
    window.addEventListener('beforeunload', function (e) {
        e.preventDefault();
        e.returnValue = '';
    });
</script>
{% endblock %}
